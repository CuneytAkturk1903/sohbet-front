<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Canlı Sesli & Yazılı Sohbet</title>
<style>
 body{font-family:Arial;}  #chat{border:1px solid #999;height:300px;
 overflow-y:auto;padding:8px;margin-top:10px;}
</style>
</head>
<body>
<h1>Canlı Sohbet Odası</h1>

<input id="username" placeholder="Adın" />
<button onclick="joinLobby()">Lobiye Katıl</button>
<button id="micBtn" onclick="toggleMic()" disabled>🎙️ Mikrofon Aç</button>

<div id="chat"></div>

<input id="msg" placeholder="Mesaj yaz…" style="width:70%" />
<button onclick="sendMsg()">Gönder</button>

<script>
let socket, mediaRec, micOn = false;

window.onload = () => {
  // 1 kez açılır
  socket = new WebSocket('wss://sohbet-0mf8.onrender.com');   // <-- BURAYI değiştir
  socket.onopen = () => console.log('WS bağlandı');
  socket.onmessage = (e) => {
    if (typeof e.data === 'string') addText(e.data);
    else playBlob(e.data);
  };
};

function joinLobby(){
  const name=document.getElementById('username').value.trim();
  if(!name){alert('İsim gir!');return;}
  document.getElementById('micBtn').disabled=false;
  addText(`*** ${name} katıldı ***`);
}

function sendMsg(){
  const txt=document.getElementById('msg').value.trim();
  if(txt && socket.readyState===1){
    socket.send(JSON.stringify({type:'text',msg:txt}));
    document.getElementById('msg').value='';
  }
}

function addText(t){
  const chat=document.getElementById('chat');
  chat.innerHTML+=`<div>${t}</div>`; chat.scrollTop=chat.scrollHeight;
}

function playBlob(b){
  const url=URL.createObjectURL(b); new Audio(url).play();
}

async function toggleMic(){
  if(micOn){ mediaRec.stop(); micOn=false; 
             document.getElementById('micBtn').innerText='🎙️ Mikrofon Aç'; return; }
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRec=new MediaRecorder(stream,{mimeType:'audio/webm'});
  mediaRec.ondataavailable=(e)=>socket.readyState===1&&socket.send(e.data);
  mediaRec.start(300);      // her 300 ms blob gönder
  micOn=true;
  document.getElementById('micBtn').innerText='⏸️ Mikrofon Kapat';
}
</script>
</body>
</html>
