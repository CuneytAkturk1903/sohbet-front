<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CanlÄ± Sesli ve YazÄ±lÄ± Sohbet</title>
</head>
<body>
    <h1>CanlÄ± Sohbet OdasÄ±</h1>

    <input type="text" id="username" placeholder="AdÄ±nÄ±z...">
    <button onclick="joinLobby()">Lobiye KatÄ±l</button>

    <div id="chat" style="border: 1px solid black; height: 300px; overflow-y: scroll; margin-top: 10px;"></div>

    <input type="text" id="message" placeholder="Mesaj yazÄ±n..." style="width:80%;">
    <button onclick="sendMessage()">GÃ¶nder</button>

    <br><br>

    <button onclick="toggleMic()">ğŸ™ï¸ Mikrofona BaÅŸla</button>

    <script>
        let socket;
        let mediaRecorder;
        let audioChunks = [];
        let isMicOn = false;

        function joinLobby() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert("Ä°sim gir!");
                return;
            }

            socket = new WebSocket("wss://sohbet-0mf8.onrender.com"); // BURAYA kendi server WebSocket URL'ni yazacaksÄ±n.

            socket.onopen = () => {
                console.log("BaÄŸlantÄ± kuruldu");
            };

            socket.onmessage = (event) => {
                if (typeof event.data === "string") {
                    const chat = document.getElementById('chat');
                    chat.innerHTML += `<div>${event.data}</div>`;
                    chat.scrollTop = chat.scrollHeight;
                } else {
                    const audioBlob = event.data;
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            };
        }

        function sendMessage() {
            const message = document.getElementById('message').value;
            if (message && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: "text", message: message }));
                document.getElementById('message').value = "";
            }
        }

        function toggleMic() {
            if (isMicOn) {
                stopMic();
            } else {
                startMic();
            }
        }

        function startMic() {
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start(300); // Her 300 ms'de bir veri yollayacak

                mediaRecorder.addEventListener("dataavailable", event => {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(event.data);
                    }
                });

                isMicOn = true;
            })
            .catch(err => {
                console.error('Mikrofon hatasÄ±:', err);
                alert("Mikrofon izni gerekiyor!");
            });
        }

        function stopMic() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            isMicOn = false;
        }
    </script>
</body>
</html>
